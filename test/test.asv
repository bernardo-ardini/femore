clear;
close all;

addpath("../scr");

% geometry

system("gmsh square.geo");

geo=Geometry();
mesh;
geo.vertices=msh.POS(:,1:2);
geo.triangles=msh.TRIANGLES(:,1:3);
geo.lines=msh.LINES;
geo.initialize();

% function space

V=FunctionSpace(geo,"P12b");
V.setLinesConstraint(1);

Q=FunctionSpace(geo,"P1");

% Stokes problem

sp=StokesProblem(V,Q);
sp.mu=0.1;
sp.c=0;

[A,B]=sp.assemble();

[u,p]=sp.solve(@(x) (x(2)>=0.99)*[1;0]);

subplot(2,2,1);
style="-";
title("p");
patch("Faces",geo.triangles,"Vertices",geo.vertices,'FaceVertexCData',p.dof,'FaceColor','interp','LineStyle',style);
pbaspect([1,1,1]);
daspect([1,1,1]);
colorbar;

subplot(2,2,2);
title("u");
quiver(geo.vertices(:,1),geo.vertices(:,2),u.dof(1:geo.numvertices),u.dof((1:geo.numvertices)+geo.numvertices+geo.numtriangles));
pbaspect([1,1,1]);
daspect([1,1,1]);

subplot(2,2,3);
style="-";
title("u_1");
patch("Faces",geo.triangles,"Vertices",geo.vertices,'FaceVertexCData',u.dof(1:geo.numvertices),'FaceColor','interp','LineStyle',style);
pbaspect([1,1,1]);
daspect([1,1,1]);
colorbar;

subplot(2,2,4);
style="-";
title("u_2");
patch("Faces",geo.triangles,"Vertices",geo.vertices,'FaceVertexCData',u.dof((1:geo.numvertices)+geo.numvertices+geo.numtriangles),'FaceColor','interp','LineStyle',style);
pbaspect([1,1,1]);
daspect([1,1,1]);
colorbar;

figure;
[startX,startY]=meshgrid(0.5,0:0.1:1);
[x,y]=meshgrid(geo.vertices(:,1),geo.vertices(:,2));
[U,V]=meshgrid(u.dof(1:geo.numvertices),u.dof((1:geo.numvertices)+geo.numvertices+geo.numtriangles));
verts=stream2(x,y,U,startX,startY);
streamline(verts);